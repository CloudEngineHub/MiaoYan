<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1.0" />
  <meta name="color-scheme" content="light dark" />

  <!-- Basic styles -->
  <style>
    img {
      image-rendering: auto;
      color-scheme: only light;
      image-orientation: from-image;
      max-width: 100%;
      height: auto;
    }
  </style>

  DOWN_META

  <!-- CSS -->
  <link rel="stylesheet" href="css/heti.min.css" />
  <link rel="stylesheet" href="css/katex.min.css" />
  <link rel="stylesheet" href="css/index.css" />

  <!-- Vendor libraries -->
  <script src="js/heti-addon.min.js"></script>
  <script src="js/highlight.min.js"></script>
  <script src="js/mermaid.min.js"></script>
  <script src="js/plantuml-encoder.min.js"></script>
  <script src="js/katex.min.js"></script>
  <script src="js/auto-render.min.js"></script>
  <script src="js/emoji.min.js"></script>
  <script src="js/d3.min.js"></script>
  <script src="js/markmap.min.js"></script>
  <script src="js/markmap-view.min.js"></script>

  <script src="js/lightense.min.js"></script>

  <!-- MiaoYan modules -->
  <script src="js/index.js"></script>

  <script>
    if ('CUSTOM_CSS' === 'darkmode') {
      document.documentElement.classList.add('darkmode');
    }
  </script>

  <title></title>

  <style>
    @font-face {
      font-family: 'TsangerJinKai02-W04';
      font-display: fallback;
      src: url('DOWN_FONT_PATH/TsangerJinKai02-W04.ttf') format('truetype');
    }

    DOWN_CSS
  </style>
</head>

<body>
  <script>
    if ('CUSTOM_CSS' === 'darkmode') {
      document.body.classList.add('darkmode');
    }
  </script>
  <div class="markdown-body heti" id="write">DOWN_HTML</div>
  <script>
    if ('CUSTOM_CSS' === 'darkmode') {
      document.getElementById('write').classList.add('darkmode');
    }
  </script>

  <!-- Initialize core libraries first -->
  <script>
    // Initialize core functionality using common module
    MiaoYanCommon.initializeCore();
    MiaoYanCommon.setupTextSelection();

    // Apply dark mode theme if needed
    if ('CUSTOM_CSS' === 'darkmode') {
      ThemeConfig.applyDarkModeStyles();
    }

    // Initialize KaTeX and additional features when DOM is ready
    MiaoYanCommon.onDOMReady(function() {
      // Initialize KaTeX first
      renderMathInElement(document.body, {
        delimiters: [
          {left: "$$", right: "$$", display: true},
          {left: "$", right: "$", display: false},
          {left: "\\(", right: "\\)", display: false},
          {left: "\\[", right: "\\]", display: true}
        ]
      });

      // Setup header anchors, image optimization and zoom
      MiaoYanCommon.setupHeaderAnchors();
      MiaoYanCommon.optimizeImages();
      MiaoYanCommon.setupImageZoom();

      // Initialize diagrams after DOM is ready
      setTimeout(() => {
        DiagramHandler.initializeAll();
      }, 100);
    });
  </script>

  <!-- Main app for additional functionality -->
  <script src="js/app.js"></script>
</body>
</html>
